# TP2 : Environnement virtuel

## I. Topologie réseau

☀️ Sur node1.lan1.tp2

- afficher ses cartes réseau

```
[hugo@node1lan1 ~]$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:30:02:9e brd ff:ff:ff:ff:ff:ff
    inet 10.1.1.11/24 brd 10.1.1.255 scope global noprefixroute enp0s3
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fe30:29e/64 scope link
       valid_lft forever preferred_lft forever
```

- afficher sa table de routage

```
[hugo@node1lan1 ~]$ ip route show
10.1.1.0/24 dev enp0s3 proto kernel scope link src 10.1.1.11 metric 100
10.1.2.0/24 via 10.1.1.254 dev enp0s3 proto static metric 100
```

- prouvez qu'il peut joindre node2.lan2.tp2

```
[hugo@node1lan1 ~]$ ping 10.1.2.12
PING 10.1.2.12 (10.1.2.12) 56(84) bytes of data.
64 bytes from 10.1.2.12: icmp_seq=1 ttl=63 time=6.00 ms
64 bytes from 10.1.2.12: icmp_seq=2 ttl=63 time=5.68 ms
64 bytes from 10.1.2.12: icmp_seq=3 ttl=63 time=6.48 ms
64 bytes from 10.1.2.12: icmp_seq=4 ttl=63 time=9.49 ms
^C
--- 10.1.2.12 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3008ms
rtt min/avg/max/mdev = 5.680/6.914/9.494/1.516 ms
```

- prouvez avec un traceroute que le paquet passe bien par router.tp2

```
[hugo@node1lan1 ~]$ traceroute -4 10.1.2.12
traceroute to 10.1.2.12 (10.1.2.12), 30 hops max, 60 byte packets
 1  10.1.1.254 (10.1.1.254)  2.929 ms  3.079 ms  3.049 ms
 2  10.1.2.12 (10.1.2.12)  12.661 ms !X  8.882 ms !X  8.881 ms !X
```

## II. Interlude accès internet

☀️ Sur router.tp2

- prouvez que vous avez un accès internet (ping d'une IP publique)

```
[hugo@router ~]$ ping 1.1.1.1
PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data.
64 bytes from 1.1.1.1: icmp_seq=1 ttl=54 time=23.9 ms
64 bytes from 1.1.1.1: icmp_seq=2 ttl=54 time=26.3 ms
64 bytes from 1.1.1.1: icmp_seq=3 ttl=54 time=23.4 ms
64 bytes from 1.1.1.1: icmp_seq=4 ttl=54 time=24.8 ms
^C
--- 1.1.1.1 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3010ms
rtt min/avg/max/mdev = 23.408/24.627/26.342/1.114 ms
```

- prouvez que vous pouvez résoudre des noms publics (ping d'un nom de domaine public)

```
[hugo@router ~]$ ping youtube.com
PING youtube.com (142.251.37.238) 56(84) bytes of data.
64 bytes from mrs09s16-in-f14.1e100.net (142.251.37.238): icmp_seq=1 ttl=112 time=23.3 ms
64 bytes from mrs09s16-in-f14.1e100.net (142.251.37.238): icmp_seq=2 ttl=112 time=24.3 ms
64 bytes from mrs09s16-in-f14.1e100.net (142.251.37.238): icmp_seq=3 ttl=112 time=24.9 ms
64 bytes from mrs09s16-in-f14.1e100.net (142.251.37.238): icmp_seq=4 ttl=112 time=24.4 ms

--- youtube.com ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3009ms
rtt min/avg/max/mdev = 23.298/24.229/24.910/0.584 ms
```

☀️ Accès internet LAN1 et LAN2

- dans le compte-rendu, mettez-moi que la conf des points précédents sur node2.lan1.tp2

```
[hugo@node2lan1 ~]$ sudo cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

```
[hugo@node2lan1 ~]$ cat /etc/sysconfig/network-scripts/route-enp0s3
default via 10.1.1.254 dev enp0s9
10.1.2.0/24 via 10.1.1.254 dev enp0s3
```

- prouvez que node2.lan1.tp2 a un accès internet :

  - il peut ping une IP publique

    ```
    [hugo@node2lan1 ~]$ ping 188.114.96.6
    PING 188.114.96.6 (188.114.96.6) 56(84) bytes of data.
    64 bytes from 188.114.96.6: icmp_seq=1 ttl=53 time=28.1 ms
    64 bytes from 188.114.96.6: icmp_seq=2 ttl=53 time=24.9 ms
    64 bytes from 188.114.96.6: icmp_seq=3 ttl=53 time=28.1 ms
    64 bytes from 188.114.96.6: icmp_seq=4 ttl=53 time=29.3 ms
    ^C
    --- 188.114.96.6 ping statistics ---
    4 packets transmitted, 4 received, 0% packet loss, time 3008ms
    rtt min/avg/max/mdev = 24.904/27.605/29.286/1.631 ms
    ```

  - il peut ping un nom de domaine public

    ```
    [hugo@node2lan1 ~]$ ping youtube.com
    PING youtube.com (172.217.171.238) 56(84) bytes of data.
    64 bytes from mrs09s07-in-f14.1e100.net (172.217.171.238): icmp_seq=1 ttl=112 time=25.2 ms
    64 bytes from mrs09s07-in-f14.1e100.net (172.217.171.238): icmp_seq=2 ttl=112 time=26.8 ms
    64 bytes from mrs09s07-in-f14.1e100.net (172.217.171.238): icmp_seq=3 ttl=112 time=28.2 ms
    64 bytes from mrs09s07-in-f14.1e100.net (172.217.171.238): icmp_seq=4 ttl=112 time=28.7 ms
    ^C
    --- youtube.com ping statistics ---
    4 packets transmitted, 4 received, 0% packet loss, time 3009ms
    rtt min/avg/max/mdev = 25.163/27.236/28.719/1.385 ms
    ```

## III. Services réseau

### 1. Web web web

☀️ Sur web.lan2.tp2

- prouvez qu'il y a un programme NGINX qui tourne derrière le port 80 de la machine (commande ss)

```
[hugo@weblan2 ~]$ ss -atnl
State   Recv-Q  Send-Q   Local Address:Port     Peer Address:Port  Process  LISTEN  0       128            0.0.0.0:22            0.0.0.0:*
LISTEN  0       511            0.0.0.0:80            0.0.0.0:*
LISTEN  0       128               [::]:22               [::]:*
LISTEN  0       511               [::]:80               [::]:*
```

- prouvez que le firewall est bien configuré

```
[hugo@weblan2 ~]$ sudo !!
sudo firewall-cmd --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: enp0s3
  sources:
  services: cockpit dhcpv6-client ssh
  ports: ☀️80/tcp☀️
  protocols:
  forward: yes
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

☀️ Sur node1.lan1.tp2

- éditez le fichier hosts pour que site_nul.tp2 pointe vers l'IP de web.lan2.tp2

```
[hugo@node1lan1 ~]$ cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
10.1.2.12   site_nul.tp2
```

- visitez le site nul avec une commande curl et en utilisant le nom site_nul.tp2

```
[hugo@node1lan1 ~]$ curl site_nul.tp2
<h1>hello</h1>
```

### 2. Or is it ? Bonus : DHCP

☀️ Sur dhcp.lan1.tp2

- n'oubliez pas de renommer la machine (node2.lan1.tp2 devient dhcp.lan1.tp2)

```
[hugo@dhcplan1 ~]$ hostname
dhcplan1
```

- changez son adresse IP en 10.1.1.253

```
[hugo@dhcplan1 ~]$ ip a
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:e4:dd:5a brd ff:ff:ff:ff:ff:ff
    inet 10.1.1.253/24 brd 10.1.1.255 scope global noprefixroute enp0s3
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fee4:dd5a/64 scope link
       valid_lft forever preferred_lft forever
```

- setup du serveur DHCP

    - commande d'installation du paquet

    ```
    [hugo@dhcplan1 ~]$ sudo dnf -y install dhcp-server
    ```

    - fichier de conf

    ```
    [hugo@dhcplan1 ~]$ sudo cat /etc/dhcp/dhcpd.conf
    #
    # DHCP Server Configuration file.
    #   see /usr/share/doc/dhcp-server/dhcpd.conf.example
    #   see dhcpd.conf(5) man page
    #
    # create new
    # specify domain name
    option domain-name     "srv.world";
    # specify DNS server's hostname or IP address
    option domain-name-servers     dlp.srv.world;
    # default lease time
    default-lease-time 600;
    # max lease time
    max-lease-time 7200;
    # this DHCP server to be declared valid
    authoritative;
    # specify network address and subnetmask
    subnet 10.1.1.0 netmask 255.255.255.0 {
    # specify the range of lease IP address
    range dynamic-bootp 10.1.1.100 10.1.1.200;
    # specify broadcast address
    option broadcast-address 10.0.0.255;
    # specify gateway
    option routers 10.1.1.254;
    option domain-name-servers 1.1.1.1;
}
    ```

    - service actif

    ```
    [hugo@dhcplan1 ~]$ journalctl -xeu dhcpd.service
    Oct 04 16:09:52 dhcplan1 systemd[1]: Starting DHCPv4 Server Daemon...
    ░░ Subject: A start job for unit dhcpd.service has begun execution
    ░░ Defined-By: systemd
    ░░ Support: https://wiki.rockylinux.org/rocky/support
    ░░
    ░░ A start job for unit dhcpd.service has begun execution.
    ░░
    ░░ The job identifier is 3465.
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: Internet Systems Consortium DHCP Serv>
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: Copyright 2004-2019 Internet Systems >
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: All rights reserved.
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: For info, please visit https://www.is>
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: ldap_gssapi_principal is not set,GSSA>
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: Not searching LDAP since ldap-server,>
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: Config file: /etc/dhcp/dhcpd.conf
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: Database file: /var/lib/dhcpd/dhcpd.l>
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: PID file: /var/run/dhcpd.pid
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: Source compiled to use binary-leases
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: Wrote 0 leases to leases file.
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: Listening on LPF/enp0s3/08:00:27:e4:d>
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: Sending on   LPF/enp0s3/08:00:27:e4:d>
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: Sending on   Socket/fallback/fallback>
    Oct 04 16:09:52 dhcplan1 dhcpd[2165]: Server starting service.
    Oct 04 16:09:52 dhcplan1 systemd[1]: Started DHCPv4 Server Daemon.
    ░░ Subject: A start job for unit dhcpd.service has finished successfully
    ░░ Defined-By: systemd
    ░░ Support: https://wiki.rockylinux.org/rocky/support
    ░░
    ░░ A start job for unit dhcpd.service has finished successfully.
    ░░
    ░░ The job identifier is 3465.
    ```

☀️ Sur node1.lan1.tp2

- prouvez que vous avez bien récupéré une IP via le DHCP

```
[hugo@node1lan1 ~]$ ip a
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:30:02:9e brd ff:ff:ff:ff:ff:ff
    inet 10.1.1.100/24 brd 10.1.1.255 scope global dynamic noprefixroute enp0s3
       valid_lft 476sec preferred_lft 476sec
    inet6 fe80::a00:27ff:fe30:29e/64 scope link
       valid_lft forever preferred_lft forever
```

- prouvez que vous avez bien récupéré l'IP de la passerelle

```
[hugo@node1lan1 ~]$ ip route show
default via 10.1.1.254 dev enp0s3 proto static metric 100
☀️default via 10.1.1.254 dev enp0s3 proto dhcp src 10.1.1.100 metric 100☀️
10.1.1.0/24 dev enp0s3 proto kernel scope link src 10.1.1.100 metric 100
10.1.2.0/24 via 10.1.1.254 dev enp0s3 proto static metric 100
```

- prouvez que vous pouvez ping node1.lan2.tp2

```
[hugo@node1lan1 ~]$ ping 10.1.2.11
PING 10.1.2.11 (10.1.2.11) 56(84) bytes of data.
64 bytes from 10.1.2.11: icmp_seq=1 ttl=63 time=9.47 ms
64 bytes from 10.1.2.11: icmp_seq=2 ttl=63 time=3.39 ms
64 bytes from 10.1.2.11: icmp_seq=3 ttl=63 time=8.34 ms
64 bytes from 10.1.2.11: icmp_seq=4 ttl=63 time=3.65 ms
^C
--- 10.1.2.11 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3009ms
rtt min/avg/max/mdev = 3.390/6.212/9.474/2.725 ms
```